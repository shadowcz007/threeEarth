<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - shaders - sky sun shader</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		  <script src="js/libs/jquery.min.js"></script>
		 
		<style>

			body {
				color: #000;
				font-family:Monospace;
				font-size:12px;
				text-align:center;
				font-weight: bold;

				background-color: #fff;
				margin: 0px;
				overflow: hidden;
				 
			}

			#info {
				color:#ccc;
				text-shadow: 1px 1px rgba(0,0,0,0.25);
				position: absolute;
				top: 0px; width: 100%;
				padding: 5px;

			}

			#chart{
			  position: absolute;
  left: 22%;
  bottom: 2%;
  height: 220px;
  width: 70%;
  
			}

			#test{
position: absolute;
  top: 56px;
  left: 4%;
  bottom: 2%;
  width: 15%;
  height: auto;
   background: rgba(0,0,0,0.2);
  border: 1px solid white;
  color: white;
  overflow: scroll;
			}

		</style>
	</head>
	<body>

		 <div id="container"></div>
    <div id="info">5G- earth demo</div>
    <div id="chart"></div>
    
  <div id="test">旋转</div>

  	<script src="js/libs/three.min.js"></script>
  
    <script src="js/libs/renderers/Projector.js"></script>
    <script src="js/libs/renderers/CanvasRenderer.js"></script>
   
 

	

		<script src="js/libs/controls/OrbitControls.js"></script>
		<script src="js/libs/SkyShader.js"></script>

		<script src="js/libs/Detector.js"></script>
		<script src="js/libs/dat.gui.min.js"></script>

		 <script src="js/libs/stats.min.js"></script>


  <script src="js/libs/esl.js"></script>
        <script src="js/libs/config.js"></script>
        <script src="js/libs/facePrint.js"></script>
        
		<script type="text/javascript" src="js/mychart.js"></script>


		<script type="text/javascript" src="js/app.js"></script>
		<script>


			if ( ! Detector.webgl ) Detector.addGetWebGLMessage();
		
			  var gpsSize=2; //终端显示大小
	          var Jsize=4;   //基站大小
	       		 var Jheight=250;//基站高度
	       		 var gpsColor=new THREE.Color( 0x66FFFF );
	       		 var JColor=new THREE.Color( 0xFFCC00 );

	       		 var _time=250;
	       		 var _gpsNums=10000;



			  var earthRadiu=600;
			   var earthmesh ;
				var rotationControl=true;

		      var _data=[];
		      var _fontsize=120;
		      var container, stats;
		      var camera, controls,scene, renderer;

		      var raycaster, mouse;

		      var group,markerAll;
		      var sky, sunSphere;

 				var marker=[];

		      var mouseX = 0, mouseY = 0;

		      var windowHalfX = window.innerWidth / 2;
		      var windowHalfY = window.innerHeight / 2;
			









			

			init();
			animate();


			

		      function GUIController(){

						var GUIController  = {
							gpsSize:2,//终端显示大小
					        Jsize:4,   //基站大小
					       	Jheight:250,//基站高度
					     	_time:250,
					       	_gpsNums:2000,
							earthRadiu:600,
							rotationControl:false,
							_fontsize:120 
						};						

						function guiChanged() {
							gpsSize=GUIController.gpsSize;
							Jsize=GUIController.Jsize;   //基站大小
					       	Jheight=GUIController.Jheight;//基站高度
					     	_time=GUIController._time;
					       	_gpsNums=GUIController._gpsNums;
							earthRadiu=GUIController.earthRadiu;
							rotationControl=GUIController.rotationControl;
							_fontsize=GUIController._fontsize;					
						//	console.log(GUIController);
						//	animate();
							renderer.render( scene, camera );

						}

						var gui = new dat.GUI();

						gui.add( GUIController, "gpsSize", 1.0, 100.0, 2).onChange( guiChanged );				
						gui.add( GUIController, "Jsize", 4.0, 20.0, 4).onChange( guiChanged );	
						gui.add( GUIController, "Jheight", 120, 500.0, 250).onChange( guiChanged );	
						gui.add( GUIController, "_time", 250, 5000.0, 250).onChange( guiChanged );	
						gui.add( GUIController, "_gpsNums", 1000, 10000, 1000).onChange( guiChanged );	
						gui.add( GUIController, "earthRadiu", 300, 1000, 1).onChange( guiChanged );	
						gui.add( GUIController, "_fontsize", 100, 120.0, 2).onChange( guiChanged );		
						gui.add( GUIController, "rotationControl").onChange( guiChanged );	
						
						guiChanged();


				}


			function initSky() {

				// Add Sky Mesh
				sky = new THREE.Sky();
				scene.add( sky.mesh );

				// Add Sun Helper
				sunSphere = new THREE.Mesh(
					new THREE.SphereBufferGeometry( 20000, 16, 8 ),
					new THREE.MeshBasicMaterial( { color: 0xffffff } )
				);
				sunSphere.position.y = - 700000;
				sunSphere.visible = false;
				scene.add( sunSphere );

				/// GUI

				var effectController  = {
					turbidity: 1,
					reileigh: 0,
					mieCoefficient: 0.026,
					mieDirectionalG: 0.98,
					luminance: 0.7,
					inclination: 0.5, // elevation / inclination
					azimuth: 0.24, // Facing front,
					sun: ! true
				};

				var distance = 400000;

				

					var uniforms = sky.uniforms;
					uniforms.turbidity.value = effectController.turbidity;
					uniforms.reileigh.value = effectController.reileigh;
					uniforms.luminance.value = effectController.luminance;
					uniforms.mieCoefficient.value = effectController.mieCoefficient;
					uniforms.mieDirectionalG.value = effectController.mieDirectionalG;

					var theta = Math.PI * ( effectController.inclination - 0.5 );
					var phi = 2 * Math.PI * ( effectController.azimuth - 0.5 );

					sunSphere.position.x = distance * Math.cos( phi );
					sunSphere.position.y = distance * Math.sin( phi ) * Math.sin( theta );
					sunSphere.position.z = distance * Math.sin( phi ) * Math.cos( theta );

					sunSphere.visible = effectController.sun;

					sky.uniforms.sunPosition.value.copy( sunSphere.position );

				//	renderer.render( scene, camera );

				
/*
				var gui = new dat.GUI();

				gui.add( effectController, "turbidity", 1.0, 20.0, 0.1 ).onChange( guiChanged );
				gui.add( effectController, "reileigh", 0.0, 4, 0.001 ).onChange( guiChanged );
				gui.add( effectController, "mieCoefficient", 0.0, 0.1, 0.001 ).onChange( guiChanged );
				gui.add( effectController, "mieDirectionalG", 0.0, 1, 0.001 ).onChange( guiChanged );
				gui.add( effectController, "luminance", 0.0, 2 ).onChange( guiChanged );
				gui.add( effectController, "inclination", 0, 1, 0.0001 ).onChange( guiChanged );
				gui.add( effectController, "azimuth", 0, 1, 0.0001 ).onChange( guiChanged );
				gui.add( effectController, "sun" ).onChange( guiChanged );

				guiChanged();
/*/
			}

			function init() {
				//data

      			_data=loadTXT();
      

				container = $('#container').get(0);

				camera = new THREE.PerspectiveCamera( 50, window.innerWidth / window.innerHeight, 100, 2000000 );
				camera.position.set( 0, 100, 2000 );

				//camera.setLens(20);

				scene = new THREE.Scene();
				scene.fog = new THREE.Fog( 0xFFFFCC, 10, 6800 );

				group = new THREE.Group();
				markerAll= new THREE.Group();
				group.add(markerAll);
        		scene.add(group);


		        // earth 

		        var loader = new THREE.TextureLoader();
		        loader.load( 'textures/planets/earth_lights_2048.png', function ( texture ) {

		            var earth = new THREE.SphereGeometry(earthRadiu, 20, 20 );

		            var material = new THREE.MeshBasicMaterial( { map: texture, overdraw: 0.5 } );
		             earthmesh = new THREE.Mesh( earth, material );
		            group.add(earthmesh);  
		       
		       //    var  edges = new THREE.FaceNormalsHelper( earthmesh, 2, 0x00ff00, 1 );
		        //    scene.add( edges );
/*测试随机点的显示
					var pos1;
					var marker;
					var randomGPS=GPSRandom(-80.8154296875,-0.1428221177,100);					
					for (var i = randomGPS.length - 1; i >= 0; i--) {

							pos1=translateGeoCoords(randomGPS[i].lon, randomGPS[i].lat);

							marker=marker3D(pos1,1);
							console.log(marker);
							marker.lookAt(group.position);
							markerAll.add(marker);
					};
					
				*/	


		            //marker 文字 0

		            for (var i = _data.length - 1; i >= 0; i--) {
		            	if (_data[i].PointType=="0") {

 							marker[i]=marker3D(_data[i].PosVector3,0);
 							//console.log(marker[i].bound[0]);
		              		marker[i].lookAt(group.position);
		              	//  mesh.lookAt(earthmesh.container.position);
		               		// console.log("jizhan");
		              		// console.log(marker[i]);
		              		markerAll.add(marker[i]);		               
		            //文字
		            		var text=createXYZText(_data[i].cityName,_data[i].PosVector3);
		                
		                 	markerAll.add(text);

		            	};
		             
		            };




		            /// GUI
/*
						var MarkerController  = {
							Person: 10,							
							all: ! true
						};

						var distance = 400000;

						function guiChanged() {
							marker.length=MarkerController.Person;
												

							renderer.render( scene, camera );

						}

						var gui = new dat.GUI();

						gui.add( MarkerController, "Person", 1.0, 20.0, 10 ).onChange( guiChanged );				

						guiChanged();

*/

		        } );

		        raycaster = new THREE.Raycaster();

				mouse = new THREE.Vector2();



			//	var helper = new THREE.GridHelper( 5000, 2, 0xffffff, 0xffffff );
			//	scene.add( helper );

				renderer = new THREE.WebGLRenderer();
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				document.body.appendChild( renderer.domElement );
/*
				controls = new THREE.OrbitControls( camera, renderer.domElement );
				controls.addEventListener( 'change', render );
				//controls.maxPolarAngle = Math.PI / 2;
				controls.enableZoom = false;
				controls.enablePan = false;
*/
				stats = new Stats();
        		container.appendChild(stats.dom );
				
				initSky();
				
				GUIController();
	

				

				document.addEventListener( 'resize', onWindowResize, false );
				document.addEventListener( 'mousewheel', onDocumentMouseWheel, false );

       			document.addEventListener( 'mousemove', onDocumentMouseMove, false );
       			
       

       			SetTimeGPS();

			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

				render();

			}
		   function onDocumentMouseMove( event ) {
		   	event.preventDefault();
		   			mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
					mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
			        mouseX = ( event.clientX - windowHalfX );
			        mouseY = ( event.clientY - windowHalfY );

	      }
   
      function onDocumentMouseWheel(event){
                if(event.wheelDelta>0){      //判断滚轮滚动方向
                    group.scale.multiplyScalar(1.02);
                }else{
                    group.scale.multiplyScalar(0.98);
                }
                render();
      }

	function animate() {

        requestAnimationFrame(animate);
		
        render();
        stats.update();

     }
	
	function render() {
		

		
			              		
		              	//  mesh.lookAt(earthmesh.container.position);
		               
		               // console.log(_data[i].PosVector3);
		              		



		raycaster.setFromCamera(mouse, camera);
		//console.log(marker);
/*
		for (var i = marker.length - 1; i >= 0; i--) {
			var intersects = raycaster.intersectObject(marker[i]);
		
			if ( intersects.length > 0 ) {						

						
						$("#main").html(_data[i].cityName);
			
			} else {

					
						console.log("nononyeah");
			

			}
		};

*/
				
		if (rotationControl) {

 				group.rotation.y -= 0.01;
    
		};
 		
 				camera.position.x += ( mouseX - camera.position.x ) * 0.05;
		        camera.position.y += ( - mouseY - camera.position.y ) * 0.05;
		        camera.lookAt( scene.position );

        renderer.render( scene, camera );
		

	}

function loadTXT(){
       
       var result=[];    
                $.ajax({
                    url: 'data.txt',
                    
                    dataType: 'text',
                    success: function(data) {
                        alert(data);
                             var loadedDataArray = data.split('\n');
                             var l = loadedDataArray.length;  
                                                    
                          for (var i = 0; i < l; i++) {
                            var locationData={};   
                            var  str = loadedDataArray[i];              
                            var entry = str.split('|');                        

                            locationData.longitude=entry[0];
                            locationData.latitude=entry[1];
                            locationData.countryName=entry[2];
                            locationData.cityName=entry[3];
                             locationData.PointType=entry[4];
                         
                            locationData.PosVector3=translateGeoCoords(locationData.latitude, locationData.longitude,5); 
                            result.push(locationData);
                          
                          } ;

                         
                        }
                    
                });
     
     return result 
     
      }
  function translateGeoCoords(latitude, longitude,add) {

                var phi = (latitude) * Math.PI / 180;
                var theta = (longitude - 180) * Math.PI / 180;

                var x = -(earthRadiu+add) * Math.cos(phi) * Math.cos(theta);
                var y = (earthRadiu+add) * Math.sin(phi);
                var z = (earthRadiu+add) * Math.cos(phi) * Math.sin(theta);

                return new THREE.Vector3(x, y, z);
            };
    
    function marker3D(PosVector3,type){
		if (type=="0") {
			//1 基站
	   		var geometry = new THREE.BoxGeometry( Jsize, Jsize, Jheight );
	        var material = new THREE.MeshBasicMaterial( {color:JColor} );
	        
	        
	        var cube = new THREE.Mesh( geometry, material );

	         cube.position.set(PosVector3.x,PosVector3.y,PosVector3.z);
		};
    
   		if (type=="1") {
   			//0 终端
	   		var geometry = new THREE.SphereGeometry( gpsSize, 2, 2 );
	        var material = new THREE.MeshBasicMaterial( {color:gpsColor});
	        var cube = new THREE.Mesh( geometry, material );
	      
	         cube.position.set(PosVector3.x,PosVector3.y,PosVector3.z);

		};
    
   

  //  var cube =  drawCylinder(1,8 ,22);
        
       
      //console.log(cube.position);      
        return cube;

    }

    function drawCylinder(topRadius,bottomRadius ,height){
                //四个参数分别是上底面半径、下底面半径，高度，半径段数
                var geometry = new THREE.CylinderGeometry(topRadius,bottomRadius,height,16);
                var material = new THREE.MeshBasicMaterial({visible:true,color:0x879378});
                var cylinder = new THREE.Mesh(geometry,material);
                return cylinder;
            }    


      function createXYZText(text,pos){
        
                var spritey = makeTextSprite( text, { fontsize: _fontsize} );
                spritey.position.set(pos.x ,pos.y ,pos.z );
                return spritey;               
            }


            /**
             * 创建永远面向相机的2D文字
             * */
     function makeTextSprite( message, parameters ){
                if ( parameters === undefined ) parameters = {};
                var fontface = parameters.hasOwnProperty("fontface") ? parameters["fontface"] : "Arial";
                var fontsize = parameters.hasOwnProperty("fontsize") ? parameters["fontsize"] : 18;
                var borderThickness = parameters.hasOwnProperty("borderThickness") ? parameters["borderThickness"] : 4;
                var textColor = parameters.hasOwnProperty("textColor") ?parameters["textColor"] : { r:255, g:255, b:255, a:1.0 };

                var canvas = document.createElement('canvas');
                var context = canvas.getContext('2d');
                context.font = "Bold " + fontsize + "px " + fontface;
                var metrics = context.measureText( message );
                var textWidth = metrics.width;

                context.lineWidth = borderThickness;

                context.fillStyle = "rgba("+textColor.r+", "+textColor.g+", "+textColor.b+", 1.0)";
                context.fillText( message, borderThickness, fontsize + borderThickness);

                var texture = new THREE.Texture(canvas)
                texture.needsUpdate = true;

                var spriteMaterial = new THREE.SpriteMaterial( { map: texture } );
                var sprite = new THREE.Sprite( spriteMaterial );
                sprite.scale.set(0.5 * fontsize, 0.25 * fontsize, 0.75 * fontsize);
                return sprite;
            }          
          
     function Spline(){
			// Create a sine-like wave
			var curve = new THREE.SplineCurve( [
				new THREE.Vector2( -10, 0 ),
				new THREE.Vector2( -5, 5 ),
				new THREE.Vector2( 0, 0 ),
				new THREE.Vector2( 5, -5 ),
				new THREE.Vector2( 10, 0 )
			] );

			var path = new THREE.Path( curve.getPoints( 50 ) );

			var geometry = path.createPointsGeometry( 50 );
			var material = new THREE.LineBasicMaterial( { color : 0xff0000 } );

			// Create the final Object3d to add to the scene
			var splineObject = new THREE.Line( geometry, material );

     }      

function addSpline(olat,olng,tlat,tlng){
	var origin=translateGeoCoords(olat,olng,5);
    var target=translateGeoCoords(tlat,tlng,50);

   
    //var mid_phi = origin_phi + ( origin_phi - target_phi )/2;
    //var mid_theta = origin_theta + ( origin_theta-target_theta ) / 2;
   // var mid_x = radius * Math.sin(mid_phi) * Math.cos(mid_theta);
   // var mid_y = radius * Math.cos(mid_phi);
   // var mid_z = radius * Math.sin(mid_phi) * Math.sin(mid_theta);

    var splineGeometry = new THREE.Geometry();

    var points = [];
    points.push(new THREE.Vector3( origin.x, origin.y, origin.z ));
//    points.push(new THREE.Vector3( mid_x, mid_y, mid_z ));
    points.push(new THREE.Vector3( target.x, target.y, target.z ));

    var spline = new THREE.SplineCurve3( points );

    for (i = 0; i < points.length; i++)
    {
        var position = spline.getPoint( i );
        splineGeometry.vertices[ i ] = new THREE.Vector3( position.x, position.y, position.z );
    }

    var color = new THREE.Color( 0xffffff );
   
    var material = new THREE.LineBasicMaterial( { color: 0x00fff00, opacity: 1, linewidth: 1 } );
    var line = new THREE.Line( splineGeometry,  material );
    return line
}


     var test=$("#test");
     function SetTimeGPS(){
     	//add gps type=1
		var randomGPS=GPSRandom(-80.8154296875,-0.1428221177,_gpsNums);

		var tnt=self.setInterval(clock,_time);
		var i = randomGPS.length - 1;
		function clock() {
			var line=addSpline(randomGPS[i].lon,randomGPS[i].lat,-0.1428221177,-80.8154296875);
			var pos=translateGeoCoords(randomGPS[i].lon, randomGPS[i].lat,5);
			var marker=marker3D(pos,1);
			marker.lookAt(group.position);
			group.add(marker);
			group.add(line);
			renderer.render( scene, camera );
			
			test.append("<p>"+Math.random()*2+"12001020</p>"); 

			//console.log(marker);
			if (i>=0) {
				i--;
			}else{
				window.clearInterval(tnt);			
			};
			
		  };

     }



     function GPSRandom(startlat,startlon,nums){
 
		
			var array1 =[];
			
			

			var lat=0;
			var lon=0;

			var p=nums;

		 
			var maxdist=200;	//移动距离	km	 
			
			
		// circular
		 	var brg = new Array(0, 180, 0);
			var j=0;

			if (startlat == 90) {
				startlat = 89.99999999;
				j=1
			}
			if (startlat == -90) {
			startlat = -89.99999999;
			j=2;
			}

			startlat= rad(startlat);
						
			

			startlon=rad(startlon);
			
			
			var radiusEarth=6372.796924;	

			

			maxdist=maxdist/radiusEarth;

			var cosdif = Math.cos(maxdist) - 1;

			var sinstartlat = Math.sin(startlat);

			var cosstartlat = Math.cos(startlat);

			var dist = 0;

			var rad360=2*Math.PI;

			

			for (i=0; i<p; i++) {
				var gps={};

				dist = Math.acos(Math.random()*cosdif + 1);

				brg[0] = rad360*Math.random();

				lat=Math.asin(sinstartlat*Math.cos(dist) + cosstartlat*Math.sin(dist)*Math.cos(brg[0]));

				lon=deg(normalizeLongitude(startlon*1 + Math.atan2(Math.sin(brg[0])*Math.sin(dist)*cosstartlat, Math.cos(dist)-sinstartlat*Math.sin(lat))));
				
				lat = deg(lat);
				
			//	dist=Math.round(dist*radiusEarth*10000)/10000;
				
				//brg[0]=Math.round(deg(brg[0])*1000)/1000;

				gps.lat=padZeroRight(lat);
				//console.log(dist);
				gps.lon=padZeroRight(lon);
			//	console.log(gps);
				array1.push(gps);
				//array1.push("w" + decimalToDMS(lat, 1) + "x" + padZeroRight(lat) + "y" + decimalToDMS(lon, 0) + "z" + padZeroRight(lon) + "j" + dist + "q" + brg[j] + "\u00B0\n");
				

			}
	 
			
			return array1;
		
			function rad(dg) {
				return (dg* Math.PI / 180);
			}
			function deg(rd) {
				return (rd* 180 / Math.PI);
			}
			function normalizeLongitude(lon) {
			var n=Math.PI;
			if (lon > n) {
			lon = lon - 2*n
			} else if (lon < -n) {
			lon = lon + 2*n
			}
			return lon;
			}
			function decimalToDMS(l, isLat) {
				var dir1="";
			if (isLat==1) {
				if (l<0) {
					dir1= "S";
					} else {
					dir1 = "N";
				}
			} else {
				if (l<0) {
					dir1= "W";
					} else {
					dir1= "E";
				}
			}
				l=Math.abs(Math.round(l*3600)/3600);
				var deg1= Math.floor(l);
				var temp=(l-deg1)*60;
				var min1=padWithZero(Math.floor(temp));
				temp=(temp-min1);
				var sec1=padWithZero(Math.round(temp*60));
				if (sec1 == 60) {
				sec1 = 59;
				}
				return Math.abs(deg1) + '\u00B0' + min1 + '\u2032' + sec1 + '\u2033' + dir1;
				}

			function padWithZero(s) {
				if (s<10) {
					s= "0" + s;
				}
				return s;
			}

			function padZeroRight(s) {
				var sigDigits=8;
				if (sigDigits>8) {
				sigDigits=8;
				} else if (sigDigits < 5) {
				sigDigits=5;
				}
				s="" + Math.round(s*Math.pow(10, sigDigits))/Math.pow(10, sigDigits);
				var i = s.indexOf('.');
				var d=(s.length-i-1);
				if (i == -1) {
					return (s + ".00");
					} else if (d == 1) {
					return (s + "0");
				} else {
					return s;
				}
			}
     }


		</script>

	</body>

</html>
